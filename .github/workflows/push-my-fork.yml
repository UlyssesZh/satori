name: Build and push

on:
  push:
    branches: [my-fork]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://npm.pkg.github.com/

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Pack
        run: npm pack --workspace packages/core --workspace adapters/discord

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: '*.tgz'
          if-no-files-found: error

  push:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download
        uses: actions/download-artifact@v4
        with:
          name: packages

      - name: Unpack
        run: |
          shopt -s nullglob
          for f in *.tgz; do
            if [[ $f =~ ^(.*)-[0-9].*\.tgz$ ]]; then
              dir="${BASH_REMATCH[1]}"
              mkdir -p "$dir"
              tar --strip-components=1 -xzf "$f" -C "$dir"
            fi
          done

      - name: Push @satorijs/core
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: satorijs-core
          build_dir: satorijs-core
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push @satorijs/adapter-discord
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: satorijs-adapter-discord
          build_dir: satorijs-adapter-discord
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
